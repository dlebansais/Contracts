# version format
version: v{build}

branches:
  only:
    - master
    - deployment

# Skipping commits with particular message or from specific user
skip_commits:
  message: "*[skip ci]*"

image: Visual Studio 2019

# scripts that are called at very beginning, before repo cloning
init:
  - git config --global core.autocrlf input

matrix:
  fast_finish: true     # set this flag to immediately finish build once one of the jobs fails.

before_build:
  - nuget restore Contracts.sln

build:
  project: build_all.xml

after_build:
  - nuget install Packager -DependencyVersion Highest -OutputDirectory packages
  - ps: $folder = (ls -d packages) | Out-String
  - ps: echo $folder
  - ps: echo $folder/lib/net48/Packager.exe
  - ps: packages/Packager.1.0.1/lib/net48/Packager.exe
  - nuget pack nuget\Contracts-Debug.nuspec
  - dotnet pack --configuration Release /p:Platform=x64 Contracts/Contracts.csproj

test: off

artifacts:
  - path: Contracts/bin/
    name: Contracts
  - path: Contracts-Debug.*.nupkg
    name: Contracts-Package-Debug
    type: NuGetPackage
  - path: Contracts/bin/x64/Release/Contracts.*.nupkg
    name: Contracts-Package-Release
    type: NuGetPackage

deploy:
  - provider: GitHub
    release: '%APPVEYOR_REPO_COMMIT_MESSAGE%'
    description: 'Automatic deployment'
    auth_token:
      secure: dUpQSnUT5/m88z1BqHNnRjaxxZzz09CmyqFJr/cAyWjqKeLgnKunlIZlEKAXlNIm
    artifact: Contracts
    draft: true
    prerelease: false
    on:
      branch: deployment
  - provider: NuGet
    server: https://nuget.pkg.github.com/dlebansais/index.json
    symbol_server: https://nuget.pkg.github.com/dlebansais/index.json
    artifact: Contracts-Package-Debug
    username: dlebansais
    api_key:
      secure: GOksqNi8I7Vs6dcsfosJvSa9vMaZH3zLQJjnx+ruJy6ZeLF075mifj4MdRI34E8W
    on:
      branch: deployment
  - provider: NuGet
    server: https://nuget.pkg.github.com/dlebansais/index.json
    artifact: Contracts-Package-Release
    skip_symbols: true
    username: dlebansais
    api_key:
      secure: GOksqNi8I7Vs6dcsfosJvSa9vMaZH3zLQJjnx+ruJy6ZeLF075mifj4MdRI34E8W
    on:
      branch: deployment
